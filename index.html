<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Aurea Saint-Maurice ‚Äì Simulateur Immo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* --- STYLE AUREA (identit√© visuelle + ergonomie iPhone) --- */
    :root {
      --aurea-bg: #fff8e8;
      --aurea-green: #6b754c;
      --aurea-gold: #e2b950;
      --aurea-text: #374151;
      --aurea-muted: #9ca3af;
      --card-bg: #ffffff;
      --border-soft: #e5e7eb;
      --shadow-soft: 0 18px 35px rgba(0, 0, 0, 0.08);
      --radius-xl: 18px;
      --radius-large: 24px;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text";
      background: radial-gradient(circle at top, #fffdf4 0, var(--aurea-bg) 45%, #f3e9d0 100%);
      color: var(--aurea-text);
    }
    .page { max-width: 1200px; margin: 0 auto; padding: 16px 16px 40px; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(16px);
      box-shadow: var(--shadow-soft);
      padding: 16px 20px; border-radius: var(--radius-large);
      margin-bottom: 18px;
    }
    .logo-block { display: flex; align-items: center; gap: 16px; }
    .logo-block img { height: 56px; width: auto; }
    .logo-text-main {
      font-size: 24px; font-weight: 600; letter-spacing: 0.08em;
      text-transform: uppercase; color: var(--aurea-green);
    }
    .logo-text-sub {
      font-size: 13px; text-transform: uppercase; letter-spacing: 0.18em;
      color: var(--aurea-muted);
    }
    .layout { display: flex; flex-direction: column; gap: 16px; }
    @media (min-width: 900px) {
      .layout { flex-direction: row; }
      .col-left { width: 45%; } .col-right { width: 55%; }
    }
    .card {
      background: white; padding: 16px; border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft); border: 1px solid rgba(0,0,0,0.02);
    }
    .card-title {
      font-size: 15px; font-weight: 600; color: var(--aurea-green);
      text-transform: uppercase; letter-spacing: 0.04em;
    }
    .inputs-grid { display: grid; gap: 8px 12px; }
    @media (min-width: 700px) { .cols-2 { grid-template-columns: repeat(2,1fr); } }
    .field { display: flex; flex-direction: column; gap: 3px; }
    .field input {
      padding: 7px 9px; font-size: 13px; border-radius: 999px;
      border: 1px solid var(--border-soft); background: #faf7ee;
    }
    .field input:focus {
      border-color: var(--aurea-green); outline: none;
      box-shadow: 0 0 0 1px rgba(107,117,76,0.18);
    }
    button {
      border-radius: 999px; padding: 7px 12px; border: none;
      background: var(--aurea-green); color: white; cursor: pointer;
    }
    .secondary { background: #f5eee0; color: var(--aurea-green); }
    .danger { background: #e56d6d; }
    .table-wrapper {
      margin-top: 8px; border-radius: 16px;
      border: 1px solid #eadfcf; overflow: scroll;
    }
    table { width: 100%; border-collapse: collapse; font-size: 11px; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #f0e7d7; }
    th { background: rgba(107,117,76,0.08); text-align: left; }
  </style>
</head>

<body>
<div class="page">

  <!-- --- EN-T√äTE --- -->
  <header>
    <div class="logo-block">
      <img src="logo-aurea.png" />
      <div>
        <div class="logo-text-main">Aurea</div>
        <div class="logo-text-sub">Saint-Maurice ‚Äì Simulateur patrimonial</div>
      </div>
    </div>
  </header>

  <div class="layout">

    <!-- --- COLONNE GAUCHE : INPUTS --- -->
    <div class="col-left">

      <div class="card">
        <div class="card-title">Acquisition</div>
        <div class="inputs-grid cols-2">

          <div class="field"><label>Prix d'achat</label>
            <input data-field="prixAchat" type="number" /></div>

          <div class="field"><label>Frais notaire %</label>
            <input data-field="fraisNotairePct" data-type="percent" /></div>

          <div class="field"><label>Travaux initiaux</label>
            <input data-field="travauxInitiaux" type="number" /></div>

          <div class="field"><label>Apport</label>
            <input data-field="apport" type="number" /></div>

          <div class="field"><label>Dur√©e pr√™t</label>
            <input data-field="dureePret" type="number" /></div>

          <div class="field"><label>Taux pr√™t %</label>
            <input data-field="tauxPret" data-type="percent" /></div>

          <div class="field"><label>Assurance %</label>
            <input data-field="tauxAssurance" data-type="percent" /></div>

        </div>
      </div>

      <div class="card">
        <div class="card-title">Loyers et charges</div>
        <div class="inputs-grid cols-2">

          <div class="field"><label>Loyers annuels</label>
            <input data-field="loyersAnnuel" /></div>

          <div class="field"><label>Croissance loyers %</label>
            <input data-field="croissanceLoyers" data-type="percent" /></div>

          <div class="field"><label>Vacance %</label>
            <input data-field="vacance" data-type="percent" /></div>

          <div class="field"><label>Frais gestion %</label>
            <input data-field="fraisGestionPct" data-type="percent" /></div>

          <div class="field"><label>Charges NR ann√©e 1</label>
            <input data-field="chargesNRAn1" /></div>

          <div class="field"><label>Croissance charges %</label>
            <input data-field="croissanceCharges" data-type="percent" /></div>

          <div class="field"><label>D√©but services</label>
            <input data-field="anneeDebutServices" /></div>

          <div class="field"><label>Revenus services AN</label>
            <input data-field="revenusServicesAnDepart" /></div>

          <div class="field"><label>Croissance services %</label>
            <input data-field="croissanceServices" data-type="percent" /></div>

          <div class="field"><label>Revalo bien %</label>
            <input data-field="revaloBienPct" data-type="percent" /></div>

        </div>
      </div>

      <div class="card">
        <div class="card-title">Fiscalit√© IS</div>
        <div class="inputs-grid cols-2">

          <div class="field"><label>Taux IS r√©duit %</label>
            <input data-field="tauxISRedit" data-type="percent" /></div>

          <div class="field"><label>Seuil IS r√©duit</label>
            <input data-field="seuilISRedit" /></div>

          <div class="field"><label>Taux IS %</label>
            <input data-field="tauxIS" data-type="percent" /></div>

          <div class="field"><label>Ann√©es projection</label>
            <input data-field="dureeProjection" /></div>

        </div>
      </div>

    </div>

    <!-- --- COLONNE DROITE : KPIS + TABLEAU --- -->
    <div class="col-right">

      <div class="card">
        <div class="card-title">Synth√®se</div>

        <p><b>Cash-flow ann√©e 1 :</b> <span id="kpi-cf1"></span></p>
        <p><b>Cash-flow moyen :</b> <span id="kpi-cf-moy"></span></p>
        <p><b>Patrimoine net final :</b> <span id="kpi-patrimoine"></span></p>
        <p><b>TRI avant IS :</b> <span id="kpi-tri-avant"></span></p>
        <p><b>TRI apr√®s IS :</b> <span id="kpi-tri-apres"></span></p>
        <p><b>Cash net SCI (vente) :</b> <span id="kpi-cash-sci"></span></p>

        <hr>

        <input id="scenario-name" placeholder="Nom du sc√©nario" />
        <button id="btn-save">üíæ Sauvegarder</button>
        <select id="scenario-select"></select>
        <button class="secondary" id="btn-load">Charger</button>
        <button class="danger" id="btn-delete">Supprimer</button>
      </div>

      <div class="card">
        <div class="card-title">Projection annuelle</div>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Ann√©e</th>
                <th>Loyers encaiss√©s</th>
                <th>Charges+Capex</th>
                <th>Annuit√©s</th>
                <th>CF avant IS</th>
                <th>IS</th>
                <th>CF apr√®s IS</th>
                <th>CRD</th>
                <th>Valeur</th>
                <th>Patrimoine</th>
              </tr>
            </thead>
            <tbody id="projection-body"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- --------------------------------------------------------------- -->
<!-- ----------------------- SCRIPT COMPLET ------------------------ -->
<!-- --------------------------------------------------------------- -->
<script>

  const defaultHypotheses = {
    prixAchat: 765000,
    fraisNotairePct: 0.0668,
    travauxInitiaux: 50000,
    apport: 235000,
    dureePret: 20,
    tauxPret: 0.0309,
    tauxAssurance: 0.0045,
    loyersAnnuel: 50280,
    croissanceLoyers: 0.02,
    vacance: 0.02,
    fraisGestionPct: 0.01,
    chargesNRAn1: 6802,
    croissanceCharges: 0.025,
    revaloBienPct: 0.02,
    anneeDebutServices: 2,
    revenusServicesAnDepart: 1500,
    croissanceServices: 0.03,
    tauxISRedit: 0.15,
    seuilISRedit: 42500,
    tauxIS: 0.25,
    dureeProjection: 20
  };

  const travauxTranches = [
    { montant: 6000,  anDebut: 2 },
    { montant: 20000, anDebut: 3 },
    { montant: 9000,  anDebut: 4 },
    { montant: 15000, anDebut: 6 }
  ];

  let hypotheses = { ...defaultHypotheses };

  function annuite(capital, taux, duree) {
    if (taux === 0) return capital / duree;
    return (capital * taux) / (1 - Math.pow(1 + taux, -duree));
  }

  function formatEuro(v) { return isFinite(v) ? v.toLocaleString("fr-FR", {maximumFractionDigits:0}) + " ‚Ç¨" : "‚Äì"; }

  function computeProjection(h) {
    const fraisNotaire = h.prixAchat * h.fraisNotairePct;
    const coutTotal = h.prixAchat + fraisNotaire + h.travauxInitiaux;
    const montantPret = h.prixAchat + fraisNotaire - h.apport;
    const annuitePret = annuite(montantPret, h.tauxPret, h.dureePret);
    const pmtTrav = annuite(1, h.tauxPret, h.dureePret);

    let crd = montantPret;
    const rows = [];

    for (let an = 1; an <= h.dureeProjection; an++) {

      const loyers = h.loyersAnnuel * Math.pow(1+h.croissanceLoyers, an-1);
      const services = an >= h.anneeDebutServices
        ? h.revenusServicesAnDepart * Math.pow(1+h.croissanceServices, an-h.anneeDebutServices)
        : 0;
      const revenusTotaux = loyers + services;
      const vacance = revenusTotaux * h.vacance;
      const loyersEncaisses = revenusTotaux - vacance;
      const fraisGest = loyersEncaisses * h.fraisGestionPct;
      const chargesNR = h.chargesNRAn1 * Math.pow(1+h.croissanceCharges, an-1);

      let capex = 0;
      if (an === 6 || an === 7) capex = 500;
      else if (an === 8) capex = 1500;
      else if (an === 9) capex = 2000;
      else if (an >= 10) capex = 3000;

      const resultatExpo = loyersEncaisses - fraisGest - chargesNR;

      const interets = crd * h.tauxPret;
      const amort = annuitePret - interets;
      crd = Math.max(0, crd - amort);

      let annTrav = 0;
      for (const t of travauxTranches) {
        if (an >= t.anDebut && an < t.anDebut + h.dureePret) {
          annTrav += t.montant * pmtTrav;
        }
      }

      const cfAvant = resultatExpo - capex - annuitePret - annTrav;
      const valeur = coutTotal * Math.pow(1+h.revaloBienPct, an);
      const patrimoine = valeur - crd;

      rows.push({
        an, loyersEncaisses, chargesNR, capex,
        annuiteTot: annuitePret + annTrav,
        cfAvant, crd, valeur, patrimoine
      });
    }
    return { coutTotal, projection: rows };
  }

  function computeIS(rows, h) {
    return rows.map(r => {
      const benef = Math.max(0, r.cfAvant);
      const is =
        benef <= h.seuilISRedit
          ? benef * h.tauxISRedit
          : h.seuilISRedit*h.tauxISRedit + (benef - h.seuilISRedit)*h.tauxIS;
      return { ...r, is, cfApres: r.cfAvant - is };
    });
  }

  function irr(cf) {
    let low=-0.9, high=1.5;
    function f(rate) { return cf.reduce((s,c,i)=>s+c/Math.pow(1+rate,i),0); }
    for (let i=0;i<80;i++){
      const mid=(low+high)/2, v=f(mid);
      if (Math.abs(v)<1e-7) return mid;
      if (f(low)*v<0) high=mid; else low=mid;
    }
    return (low+high)/2;
  }

  function computeTRI(h, rows, coutTotal) {
    const n = rows.length;
    const last = rows[n-1];

    const plusValue = last.valeur - coutTotal;
    const isPV = plusValue > 0 ? plusValue * h.tauxIS : 0;
    const cashSCI = last.valeur - last.crd - isPV;

    const cfAvant = [-h.apport, ...rows.map(r=>r.cfAvant)];
    cfAvant[n] += last.patrimoine;

    const cfApres = [-h.apport, ...rows.map(r=>r.cfApres)];
    cfApres[n] += cashSCI;

    return {
      triAvant: irr(cfAvant),
      triApres: irr(cfApres),
      cashSCI
    };
  }

  function recompute() {
    const { coutTotal, projection } = computeProjection(hypotheses);
    const rowsIS = computeIS(projection, hypotheses);
    const { triAvant, triApres, cashSCI } = computeTRI(hypotheses, rowsIS, coutTotal);

    document.getElementById("kpi-cf1").innerText = formatEuro(projection[0].cfAvant);
    document.getElementById("kpi-cf-moy").innerText =
      formatEuro(projection.reduce((s,r)=>s+r.cfAvant,0)/projection.length);
    document.getElementById("kpi-patrimoine").innerText =
      formatEuro(projection[projection.length-1].patrimoine);
    document.getElementById("kpi-tri-avant").innerText =
      (triAvant*100).toFixed(1).replace(".",",")+" %";
    document.getElementById("kpi-tri-apres").innerText =
      (triApres*100).toFixed(1).replace(".",",")+" %";
    document.getElementById("kpi-cash-sci").innerText = formatEuro(cashSCI);

    const tb = document.getElementById("projection-body");
    tb.innerHTML="";
    rowsIS.forEach(r=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${r.an}</td>
        <td>${r.loyersEncaisses.toFixed(0)}</td>
        <td>${(r.chargesNR+r.capex).toFixed(0)}</td>
        <td>${r.annuiteTot.toFixed(0)}</td>
        <td>${r.cfAvant.toFixed(0)}</td>
        <td>${r.is.toFixed(0)}</td>
        <td>${r.cfApres.toFixed(0)}</td>
        <td>${r.crd.toFixed(0)}</td>
        <td>${r.valeur.toFixed(0)}</td>
        <td>${r.patrimoine.toFixed(0)}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function initInputs() {
    document.querySelectorAll("input[data-field]").forEach(input=>{
      const f = input.dataset.field;
      const t = input.dataset.type;
      const v = hypotheses[f];
      input.value = t==="percent" ? (v*100) : v;
      input.oninput = ()=>{
        let val = parseFloat(input.value.replace(",",".")) || 0;
        if (t==="percent") val=val/100;
        hypotheses[f]=val;
        recompute();
      };
    });
  }

  const STORAGE_KEY="aurea-scenarios";

  function loadScenarioList() {
    const sel=document.getElementById("scenario-select");
    const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
    sel.innerHTML="<option value=''>Sc√©narios‚Ä¶</option>";
    Object.keys(data).forEach(name=>{
      const o=document.createElement("option");
      o.value=name; o.innerText=name;
      sel.appendChild(o);
    });
  }

  function saveScenario() {
    const name=document.getElementById("scenario-name").value.trim();
    if (!name) return alert("Nom du sc√©nario ?");
    const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
    data[name]=hypotheses;
    localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
    loadScenarioList();
  }

  function loadSelectedScenario() {
    const name=document.getElementById("scenario-select").value;
    if (!name) return;
    const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
    hypotheses={...data[name]};
    initInputs(); 
    recompute();
  }

  function deleteSelectedScenario() {
    const name=document.getElementById("scenario-select").value;
    if (!name) return;
    const data=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
    delete data[name];
    localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
    loadScenarioList();
  }

  window.onload=()=>{
    initInputs();
    loadScenarioList();
    recompute();
    document.getElementById("btn-save").onclick=saveScenario;
    document.getElementById("btn-load").onclick=loadSelectedScenario;
    document.getElementById("btn-delete").onclick=deleteSelectedScenario;
  };
</script>

</body>
</html>
